# 07.pipe

íŒŒì´í”„ëŠ” @Injectable() ë°ì½”ë ˆì´í„°ë¡œ ì£¼ì„ì´ ë‹¬ë¦° í´ë˜ìŠ¤ë¡œ, íŒŒì´í”„ íŠ¸ëœìŠ¤í¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

íŒŒì´í”„ì—ëŠ” ë‘ ê°€ì§€ ì¼ë°˜ì ì¸ ì‚¬ìš© ì‚¬ë¡€ê°€ ìˆìŠµë‹ˆë‹¤:

- transformation(ë³€í™˜): ì…ë ¥ ë°ì´í„° ë³€í™˜(ì˜ˆ: ë¬¸ì -> ì •ìˆ˜)
- validation(ìœ íš¨ì„± ê²€ì‚¬): ì…ë ¥ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬

- ìœ„ì˜ ë‘ ê²½ìš° ëª¨ë‘, íŒŒì´í”„ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ ì²˜ë¦¬ ì¤‘ì¸ ì¸ìˆ˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì‘ë™í•œë‹¤.
- NestëŠ” ë©”ì„œë“œê°€ í˜¸ì¶œë˜ê¸° ì§ì „ì— íŒŒì´í”„ë¥¼ ì‚½ì…í•˜ê³ , íŒŒì´í”„ëŠ” ë©”ì„œë“œì˜ ëŒ€ìƒì´ ë˜ëŠ” ì¸ìˆ˜ë¥¼ ë°›ì•„ ì‹¤í–‰í•œë‹¤.
- ì´ ë•Œ ëª¨ë“  ë³€í™˜ê³¼ ìœ íš¨ì„± ê²€ì‚¬ ì‘ì—…ì´ ìˆ˜í–‰ë˜ê³ , ê·¸ í›„ ë³€í™˜ëœ ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ í˜¸ì¶œëœë‹¤.

íŒŒì´í”„ëŠ” **ì˜ˆì™¸ ì˜ì—­ ë‚´ì—ì„œ ì‹¤í–‰**ëœë‹¤. ì¦‰, íŒŒì´í”„ê°€ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´, ì˜ˆì™¸ ê³„ì¸µ(ì „ì—­ ì˜ˆì™¸ í•„í„° ë° í˜„ì¬
ì»¨í…ìŠ¤íŠ¸ì— ì ìš©ë˜ëŠ” ëª¨ë“  ì˜ˆì™¸ í•„í„°ì—ì„œ ì²˜ë¦¬)ì—ì„œ ì²˜ë¦¬ëœë‹¤.

ë”°ë¼ì„œ, íŒŒì´í”„ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œê°€ ì´í›„ì— ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©°, ì´ëŠ” ì‹œìŠ¤í…œ ê²½ê³„ì—ì„œ
ì™¸ë¶€ ì†ŒìŠ¤ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•  ìˆ˜ ìˆë‹¤ëŠ” ì´ì ì„ ì œê³µí•œë‹¤.

## Built-in pipes

ê¸°ë³¸ ì œê³µ pipeëŠ” ì•„ë˜ì™€ ê°™ìœ¼ë©°, ëª¨ë‘ @nestjs/common ì—ì„œ importí•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- ValidationPipe
- ParseIntPipe
- ParseFloatPipe
- ParseBoolPipe
- ParseArrayPipe
- ParseUUIDPipe
- ParseEnumPipe
- DefaultValuePipe
- ParseFilePipe

### Built-in pipes ì˜ ê¸°ë³¸ ì‚¬ìš©ë²•

```ts
@Get(':id')
async findOne(@Param('id', ParseIntPipe) id: number) {
  return this.catsService.findOne(id);
}

@Get(':id')
async findOne(
  @Param('id', new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }))
  id: number,
) {
  return this.catsService.findOne(id);
}

// for query parameter
@Get()
async findOne(@Query('id', ParseIntPipe) id: number) {
  return this.catsService.findOne(id);
}

// For uuid. It can be set what version of uuid, ex 3, 4
@Get(':uuid')
async findOne(@Param('uuid', new ParseUUIDPipe()) uuid: string) {
  return this.catsService.findOne(uuid);
}
```

### Custom Pipes(ì‚¬ìš©ì ì •ì˜ íŒŒì´í”„)

ì´ê²ƒì€ ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ë‹¤ë£¨ë„ë¡ í•˜ê² ë‹¤.

## Schema based validation

```ts
@Post()
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}

export class CreateCatDto {
  name: string;
  age: number;
  breed: string;
}
```

ìœ„ì™€ ê°™ì€ ì½”ë“œê°€ ìˆì„ ë•Œ create ë©”ì„œë“œë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ìš”ì²­ì— ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ê³ ì í•œë‹¤.
ë”°ë¼ì„œ, createCatDto ê°ì²´ì˜ ì„¸ ë©¤ë²„ì˜ ê°’ì„ ê²€ì‚¬í•´ì•¼ í•œë‹¤.

- ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ ê²€ì‚¬í•˜ë©´ SRPì— ìœ„ë°°ë˜ë©°, ì´ìƒì ì´ì§€ ì•Šë‹¤.
- ìœ íš¨ì„± ê²€ì‚¬ê¸° í´ë˜ìŠ¤ë¥¼ ë§Œë“œëŠ” ê²ƒì€ ì´ë¯¸ ì»¨íŠ¸ë¡¤ëŸ¬ê¹Œì§€ ë“¤ì–´ì™€ì„œ ë©”ì„œë“œ ì‹œì‘ ë¶€ë¶„ì—ì„œ ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì—,
  ì´ìƒì ì´ì§€ ì•Šë‹¤.
- ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¼ë°˜ì ì¸ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“œëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ì™œëƒí•˜ë©´,
  í˜¸ì¶œë  í•¸ë“¤ëŸ¬ì™€ ê·¸ ë§¤ê°œë³€ìˆ˜ ë“± ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ì´ê²ƒì´ íŒŒì´íŠ¸ê°€ ì„¤ê³„ëœ ì‚¬ìš© ì‚¬ë¡€ì´ë‹¤.

### Class validator

ë°ì½”ë ˆì´í„° ê¸°ë°˜ ìœ íš¨ì„± ê²€ì‚¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤. ì´ê²ƒì€ íŠ¹íˆ ì²˜ë¦¬ëœ í”„ë¡œí¼í‹° ë©”íƒ€íƒ€ì…ì— ì—‘ì„¸ìŠ¤ í•  ìˆ˜ ìˆì–´,
Nestì˜ pipe ê¸°ëŠ¥ê³¼ ê²°í•©í•˜ë©´ ë§¤ìš° ê°•ë ¥í•˜ë‹¤.

```shell
npm i --save class-validator class-transformer
```

ìœ„ì˜ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ DTOí´ë˜ìŠ¤ì˜ ë©¤ë²„ì— ë¯¸ë¦¬ ì¤€ë¹„ëœ ìœ íš¨ì„± ê²€ì‚¬ìš© ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í• 
ìˆ˜ ìˆë‹¤.

```ts
import { IsString, IsInt } from 'class-validator';

export class CreateCatDto {
  @IsString()
  name: string;

  @IsInt()
  age: number;

  @IsString()
  breed: string;
}
```

ğŸ‘‰ Link: [class-validator](https://github.com/typestack/class-validator#usage)

ì´ì œ validation pipe ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

```ts
import {
  PipeTransform,
  Injectable,
  ArgumentMetadata,
  BadRequestException,
} from '@nestjs/common';
import { validate } from 'class-validator';
import { plainToInstance } from 'class-transformer';

@Injectable()
export class ValidationPipe implements PipeTransform<any> {
  async transform(value: any, { metatype }: ArgumentMetadata) {
    if (!metatype || !this.toValidate(metatype)) {
      return value;
    }
    const object = plainToInstance(metatype, value);
    const errors = await validate(object);
    if (errors.length > 0) {
      throw new BadRequestException('Validation failed');
    }
    return value;
  }

  private toValidate(metatype: Function): boolean {
    const types: Function[] = [String, Boolean, Number, Array, Object];
    return !types.includes(metatype);
  }
}
```

ì ìš©

```ts
@Post()
async create(
  @Body(new ValidationPipe()) createCatDto: CreateCatDto,
) {
  this.catsService.create(createCatDto);
}
```

### Global scoped pipe

ë°¸ë¦¬ë°ì´ì…˜íŒŒì´í”„ëŠ” ìµœëŒ€í•œ ë²”ìš©ì ìœ¼ë¡œ ë§Œë“¤ì–´ì¡Œê¸° ë•Œë¬¸ì— ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ëª¨ë“  ê²½ë¡œ í•¸ë“¤ëŸ¬ì— ì ìš©ë˜ë„ë¡
ì „ì—­ ë²”ìœ„ íŒŒì´í”„ë¡œ ì„¤ì •í•˜ë©´ ê·¸ ìœ ìš©ì„±ì„ ìµœëŒ€í•œ ë°œíœ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe());
  await app.listen(3000);
}
bootstrap();
```
